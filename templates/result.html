{% extends "base.html" %}
{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É –ï–Ω–µ–∞–≥—Ä–∞–º–∏{% endblock %}
{% block content %}

<div class="result-container">
    <h1 class="result-title">‚ú® –í–ê–® –†–ï–ó–£–õ–¨–¢–ê–¢ ‚ú®</h1>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è 1+ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ -->
    <div id="resultsContainer"></div>

    <!-- –ö–Ω–æ–ø–∫–∏ –∑–∞–≤–∂–¥–∏ –≤–Ω–∏–∑—É –ø—ñ–¥ —É—Å—ñ–º–∞ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞–º–∏ -->
    <div class="action-buttons">
        <a href="/full-description" class="btn btn-primary">üìñ –ü–æ–≤–Ω–∞ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∫–∞</a>
        <button class="btn btn-secondary" id="downloadPdfBtn">üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</button>
        <button class="btn btn-secondary" id="emailBtn">üìß –ù–∞ email</button>
    </div>
</div>

<!-- –®–∞–±–ª–æ–Ω –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É -->
<template id="resultTemplate">
    <div class="result-card-main" style="margin-bottom: 24px;">
        <div class="type-badge">
            <div class="type-number" data-field="typeNumber">-</div>
        </div>

        <div class="type-info">
            <h2 class="type-name" data-field="typeName">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤...</h2>
            <p class="type-subtitle" data-field="typeSubtitle"></p>
        </div>

        <p class="type-short-desc" data-field="shortDescription"></p>

        <div class="characteristics-grid">
            <div class="characteristics-section">
                <h3>üí™ –°–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏</h3>
                <p class="char-short" data-field="strengthsShort"></p>
                <ul data-field="strengths"></ul>
            </div>
            <div class="characteristics-section">
                <h3>üå± –û–±–ª–∞—Å—Ç—å —Ä–æ–∑–≤–∏—Ç–∫—É</h3>
                <p class="char-short" data-field="growthShort"></p>
                <ul data-field="growth"></ul>
            </div>
            <div class="characteristics-section">
                <h3>‚ù§Ô∏è –ú–æ—Ç–∏–≤–∞—Ü—ñ—ó</h3>
                <p class="char-short" data-field="motivationsShort"></p>
                <ul data-field="motivations"></ul>
            </div>
            <div class="characteristics-section">
                <h3>üò® –°—Ç—Ä–∞—Ö–∏</h3>
                <p class="char-short" data-field="fearsShort"></p>
                <ul data-field="fears"></ul>
            </div>
        </div>
    </div>
</template>

<script>
// === –†–ï–ù–î–ï–† –û–î–ù–û–ì–û –ë–õ–û–ö–£ –†–ï–ó–£–õ–¨–¢–ê–¢–£ ===
function renderOneResult(container, result) {
    const tpl = document.getElementById('resultTemplate');
    const node = tpl.content.cloneNode(true);

    function setText(field, value) {
        const el = node.querySelector(`[data-field="${field}"]`);
        if (el) el.textContent = value ?? '';
    }

    function fillList(field, items) {
        const el = node.querySelector(`[data-field="${field}"]`);
        if (!el) return;
        el.innerHTML = '';
        if (items && Array.isArray(items)) {
            items.forEach(i => {
                if (typeof i === 'string' && i.trim()) {
                    const li = document.createElement('li');
                    li.textContent = i;
                    el.appendChild(li);
                }
            });
        }
    }

    setText('typeNumber', result.personality_type);
    setText('typeName', result.type_name);
    setText('typeSubtitle', result.subtitle);
    setText('shortDescription', result.short_description);

    setText('strengthsShort', result.strengths_short);
    setText('growthShort', result.growth_short);
    setText('motivationsShort', result.motivations_short);
    setText('fearsShort', result.fears_short);

    fillList('strengths', result.strengths);
    fillList('growth', result.growth);
    fillList('motivations', result.motivations);
    fillList('fears', result.fears);

    container.appendChild(node);
}

// === –í–Ü–î–û–ë–†–ê–ñ–ï–ù–ù–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–£ (1 –∞–±–æ –∫—ñ–ª—å–∫–∞ —Ç–∏–ø—ñ–≤) ===
async function loadResult() {
    const sessionId = localStorage.getItem('enneagram_session');
    if (!sessionId) return;

    try {
        const response = await fetch(`/api/results/${sessionId}`);
        if (!response.ok) throw new Error('–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ');

        const result = await response.json();
        localStorage.setItem('enneagram_result', JSON.stringify(result));

        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';

        // –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –ø–æ–≤–µ—Ä–Ω—É–≤ –∫—ñ–ª—å–∫–∞ —Ç–æ–ø-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ ‚Äî —Ä–µ–Ω–¥–µ—Ä–∏–º–æ –≤—Å—ñ
        const resultsArray = Array.isArray(result.top_results) && result.top_results.length
            ? result.top_results
            : [result];

        resultsArray.forEach(r => renderOneResult(container, r));

    } catch (e) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '<div class="result-card-main"><h2>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</h2></div>';
    }
}

// === –ö–ù–û–ü–ö–ê PDF ===
document.getElementById('downloadPdfBtn').addEventListener('click', () => {
    const sessionId = localStorage.getItem('enneagram_session');
    window.location.href = `/api/results/${sessionId}/pdf`;
});

// === –ö–ù–û–ü–ö–ê EMAIL (–∑–∞–≥–ª—É—à–∫–∞) ===
document.getElementById('emailBtn').addEventListener('click', () => {
    const email = prompt('–í–≤–µ–¥—ñ—Ç—å –≤–∞—à email –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:');
    if (email) alert('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –±—É–¥—É—Ç—å –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –Ω–∞ ' + email);
});

// === –°–¢–ê–†–¢ ===
loadResult();
</script>

{% endblock %}
